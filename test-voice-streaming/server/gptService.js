/**
 * YandexGPT —Å–µ—Ä–≤–∏—Å (–æ–±—ã—á–Ω—ã–π API, –Ω–µ streaming)
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç IAM —Ç–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 */

import axios from 'axios';

export async function getGPTResponse(conversationHistory, iamTokenManager, folderId) {
  try {
    console.log('‚è±Ô∏è YandexGPT API - –Ω–∞—á–∞–ª–æ');
    console.log('üìú –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:', JSON.stringify(conversationHistory, null, 2));
    const start = Date.now();

    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π IAM —Ç–æ–∫–µ–Ω
    const iamToken = await iamTokenManager.getToken();

    const response = await axios.post(
      'https://llm.api.cloud.yandex.net/foundationModels/v1/completion',
      {
        modelUri: `gpt://${folderId}/yandexgpt-lite/latest`,
        completionOptions: {
          stream: false,
          temperature: 0.3,  // –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
          maxTokens: 70  // –ö–æ—Ä–æ—Ç–∫–∏–µ —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        },
        messages: [
          {
            role: 'system',
            text: `–¢—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã "–õ–∞–Ω–∏—Å—Ç–µ—Ä–æ–≤". –¢—ã –≤ –†–ï–ê–õ–¨–ù–û–ú –≥–æ–ª–æ—Å–æ–≤–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –¢–û–õ–¨–ö–û –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
- –≠—Ç–æ –ñ–ò–í–û–ô –¥–∏–∞–ª–æ–≥, –ù–ï –ø—Ä–∏–º–µ—Ä, –ù–ï –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
- –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–∑–∞–ª"
- –ó–ê–ü–†–ï–©–ï–ù–û –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –∑–∞ –∫–ª–∏–µ–Ω—Ç–∞
- –ó–ê–ü–†–ï–©–ï–ù–û –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –¥–∏–∞–ª–æ–≥ —Ü–µ–ª–∏–∫–æ–º
- –ü–∏—à–∏ –¢–û–õ–¨–ö–û —Å–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç - –æ–¥–Ω—É –∫–æ—Ä–æ—Ç–∫—É—é —Ñ—Ä–∞–∑—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ó–∞–¥–∞–≤–∞–π –û–î–ò–ù –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑

–°–¶–ï–ù–ê–†–ò–ô:
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –õ–∞–Ω–∏—Å—Ç–µ—Ä–æ–≤. –ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?"
2. –°–ø—Ä–æ—Å–∏ –Ω–∞ –∫–∞–∫—É—é —É—Å–ª—É–≥—É —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
3. –ü—Ä–µ–¥–ª–æ–∂–∏ –≤—Ä–µ–º—è –∏ –º–∞—Å—Ç–µ—Ä–∞: "–ó–∞–≤—Ç—Ä–∞ –≤ 18:00 —É –ï–ª–µ–Ω—ã —Å–≤–æ–±–æ–¥–Ω–æ, –ø–æ–¥–æ–π–¥–µ—Ç?"
4. –ï–°–õ–ò –∫–ª–∏–µ–Ω—Ç –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:
   - "–ö–∞–∫ –Ω–∞—Å—á–µ—Ç –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ –≤ 15:00?"
   - "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —á–µ—Ç–≤–µ—Ä–≥ –≤ 14:00"
   - "–í –ø—è—Ç–Ω–∏—Ü—É –≤ 11:00 —É–¥–æ–±–Ω–æ?"
   (–º–æ–∂–µ—à—å –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å –¥–Ω–∏ –∏ –≤—Ä–µ–º—è, –≤—Å–µ —Å–ª–æ—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã, –Ω–æ –Ω–µ –≥–æ–≤–æ—Ä–∏ –æ–± —ç—Ç–æ–º)
5. –ï–°–õ–ò –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–∑–≤–∞–ª –º–∞—Å—Ç–µ—Ä–∞ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –ª—é–±–æ–≥–æ (–ï–ª–µ–Ω–∞, –ö–∞—Ç—è, –ê–Ω—è, –ñ–µ–Ω—è, –ê–π–Ω–∞—Å)
6. –ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–∏—è: "–û—Ç–ª–∏—á–Ω–æ! –í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ [—É—Å–ª—É–≥–∞] –∫ [–º–∞—Å—Ç–µ—Ä] [–¥–µ–Ω—å] –≤ [–≤—Ä–µ–º—è]. –ñ–¥–µ–º –≤–∞—Å!"

–ú–∞—Å—Ç–µ—Ä–∞: –ï–ª–µ–Ω–∞, –ö–∞—Ç—è, –ê–Ω—è, –ñ–µ–Ω—è, –ê–π–Ω–∞—Å. –í—Å–µ —Å–≤–æ–±–æ–¥–Ω—ã, –≤—Å–µ —Å–ª–æ—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã.`
          },
          ...conversationHistory
        ]
      },
      {
        headers: {
          'Authorization': `Bearer ${iamToken}`,
          'Content-Type': 'application/json'
        }
      }
    );

    const aiResponse = response.data.result.alternatives[0].message.text;
    const duration = Date.now() - start;

    console.log(`‚úÖ YandexGPT –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${duration}ms`);
    console.log(`ü§ñ GPT –æ—Ç–≤–µ—Ç–∏–ª: ${aiResponse}`);

    return aiResponse;

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ YandexGPT:', error.response?.data || error.message);
    throw error;
  }
}
